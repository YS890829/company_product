# クラウドサービス比較検討レポート v4

**作成日**: 2026-01-06
**更新日**: 2026-01-06
**目的**: ユーザー個別のGemini APIキーを活用し、無料枠で運用可能な構成を検討

---

## 1. v4の新要件

### 1.1 コンセプト

| 項目 | v3 | v4 |
|-----|----|----|
| Gemini API費用負担 | サービス提供者 | **各ユーザー（自身のAPIキー）** |
| 目標 | コスト最適化 | **無料枠で完結** |
| APIキー管理 | 一元管理 | **ユーザー個別管理** |

### 1.2 Gemini API 無料枠の確認

| プラン | 料金 | レート制限 | 月間上限 |
|-------|-----|-----------|---------|
| **Gemini 1.5 Flash (無料)** | $0 | 15 RPM / 100万 TPM | **1,500リクエスト/日** |
| **Gemini 1.5 Pro (無料)** | $0 | 2 RPM / 32,000 TPM | **50リクエスト/日** |

> **参考**: 2026年1月時点のGoogle AI Studio無料枠。変更の可能性あり。

### 1.3 ユーザーあたりの利用量

| 年度 | ユーザー数 | 月間合計時間 | 1人あたり月間 | 1人あたり日間 |
|-----|----------|------------|-------------|-------------|
| 2026年 | 31名 | 3,100時間 | 100時間 | **約3.3時間（約3.3件）** |
| 2027年 | 68名 | 6,800時間 | 100時間 | **約3.3時間（約3.3件）** |

### 1.4 無料枠との整合性

| API | 日間上限 | 必要数/日 | 判定 |
|-----|---------|----------|------|
| Gemini 1.5 Flash | 1,500件 | 3.3件 | ✅ **余裕** |
| Gemini 1.5 Pro | 50件 | 3.3件 | ✅ 余裕 |

> **結論**: 1ユーザーあたり1日3-4件なら、**Gemini無料枠で十分対応可能**

---

## 2. APIキー管理方式の比較

### 2.1 選択肢一覧

| 方式 | 概要 | セキュリティ | UX | 実装難度 |
|-----|------|------------|----|---------|
| **A: クライアント保存** | ユーザーがアプリ設定画面でAPIキーを入力・保存 | △ | ◎ | ◎ 低 |
| **B: サーバー保存（暗号化）** | APIキーをサーバーに暗号化保存 | ○ | ○ | ○ 中 |
| **C: OAuth連携** | GoogleアカウントでOAuth認証、APIキー不要 | ◎ | ◎ | △ 高 |
| **D: プロキシ方式** | サーバー経由でAPI呼び出し、キーはサーバー管理 | ◎ | ○ | ○ 中 |

### 2.2 詳細比較

#### 方式A: クライアント保存（ユーザー入力）

```
┌─────────────────┐         ┌─────────────────┐
│  iPhone / Web   │         │   Gemini API    │
│                 │         │                 │
│  設定画面       │         │                 │
│  ┌───────────┐  │  直接   │                 │
│  │ APIキー   │──┼────────▶│                 │
│  │ 入力欄    │  │  呼出   │                 │
│  └───────────┘  │         │                 │
│                 │         │                 │
│  📱 ローカル   │         │                 │
│     保存       │         │                 │
└─────────────────┘         └─────────────────┘
```

| メリット | デメリット |
|---------|-----------|
| 実装が最もシンプル | APIキーがデバイスに平文保存されるリスク |
| サーバー不要でAPI呼び出し可 | ユーザーがAPIキー取得手順を理解する必要 |
| サーバーコスト削減 | キーの漏洩時はユーザー責任 |

**セキュリティ対策**:
- iOS: Keychain に暗号化保存
- Web: 暗号化してlocalStorage、または IndexedDB

---

#### 方式B: サーバー保存（暗号化）

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│  iPhone / Web   │         │     Server      │         │   Gemini API    │
│                 │         │                 │         │                 │
│  設定画面       │  送信   │  暗号化保存     │  呼出   │                 │
│  ┌───────────┐  │────────▶│  ┌───────────┐  │────────▶│                 │
│  │ APIキー   │  │         │  │ 🔐 暗号化 │  │         │                 │
│  │ 入力欄    │  │         │  │   キー    │  │         │                 │
│  └───────────┘  │         │  └───────────┘  │         │                 │
└─────────────────┘         └─────────────────┘         └─────────────────┘
```

| メリット | デメリット |
|---------|-----------|
| キーがデバイスに残らない | サーバー側で復号が必要 |
| 一元管理可能 | サーバーが侵害されると全キー漏洩リスク |
| キーローテーション対応 | 実装・運用コスト増 |

---

#### 方式C: OAuth連携（Google AI Studio OAuth）

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│  iPhone / Web   │         │  Google OAuth   │         │   Gemini API    │
│                 │         │                 │         │                 │
│  Googleログイン │  OAuth  │  トークン発行   │  呼出   │                 │
│  ┌───────────┐  │────────▶│  ┌───────────┐  │────────▶│                 │
│  │ Sign in   │  │         │  │ アクセス  │  │         │                 │
│  │ Google    │  │         │  │ トークン  │  │         │                 │
│  └───────────┘  │         │  └───────────┘  │         │                 │
└─────────────────┘         └─────────────────┘         └─────────────────┘
```

| メリット | デメリット |
|---------|-----------|
| APIキー入力不要 | Google AI Studio OAuthの対応状況が限定的 |
| 最もセキュア | 実装複雑 |
| UX最高 | 2026年1月時点で一般提供されていない可能性 |

> **注意**: Gemini APIのOAuth対応は限定的。Vertex AI経由なら可能だが、無料枠の適用が異なる。

---

#### 方式D: プロキシ方式（サーバー経由）

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│  iPhone / Web   │         │   Cloud Run     │         │   Gemini API    │
│                 │         │   (プロキシ)    │         │                 │
│  音声アップ     │  音声   │  APIキー取得    │  呼出   │                 │
│  ┌───────────┐  │────────▶│  ┌───────────┐  │────────▶│                 │
│  │ 録音      │  │         │  │ユーザーの │  │         │                 │
│  │ ファイル  │  │         │  │暗号化キー │  │         │                 │
│  └───────────┘  │         │  └───────────┘  │         │                 │
└─────────────────┘         └─────────────────┘         └─────────────────┘
```

| メリット | デメリット |
|---------|-----------|
| クライアントにキー不要 | サーバーコスト発生 |
| 処理ログ管理可能 | 方式Bと同様のサーバーリスク |
| レート制限の制御可能 | 実装工数増 |

---

### 2.3 方式評価マトリクス

| 項目 | 重み | A: クライアント | B: サーバー保存 | C: OAuth | D: プロキシ |
|-----|-----|----------------|----------------|----------|------------|
| セキュリティ | 25% | 3 | 4 | 5 | 4 |
| 実装シンプルさ | 25% | 5 | 3 | 2 | 3 |
| UX（ユーザー体験） | 20% | 3 | 4 | 5 | 4 |
| コスト | 20% | 5 | 3 | 4 | 2 |
| 運用負荷 | 10% | 5 | 3 | 3 | 3 |
| **合計** | 100% | **4.0** | **3.45** | **3.65** | **3.2** |

### 2.4 推奨方式

**方式A: クライアント保存（改良版）** を推奨

理由:
1. 無料枠活用のコンセプトに最も合致（サーバーコストも削減）
2. 実装がシンプル
3. 適切なセキュリティ対策（Keychain/暗号化）で十分安全

---

## 3. 推奨アーキテクチャ（v4）

### 3.1 全体構成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        v4 アーキテクチャ                                    │
│                   「ユーザー個別APIキー + 無料枠運用」                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────┐
│           iPhone App                │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  設定画面                   │   │
│  │  ┌───────────────────────┐ │   │
│  │  │ Gemini APIキー入力    │ │   │
│  │  │ [sk-xxxxxxxx...    ]  │ │   │
│  │  └───────────────────────┘ │   │
│  │         ↓ 保存              │   │
│  │  ┌───────────────────────┐ │   │
│  │  │ 🔐 iOS Keychain       │ │   │
│  │  │    (暗号化保存)       │ │   │
│  │  └───────────────────────┘ │   │
│  └─────────────────────────────┘   │
│                                     │
│  録音 → ローカル処理 or クラウド   │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│  処理方式の選択                     │
│                                     │
│  ┌─────────────┐  ┌─────────────┐  │
│  │ オンデバイス │  │ クラウド    │  │
│  │ 処理        │  │ 処理        │  │
│  │ (方式A-1)   │  │ (方式A-2)   │  │
│  └──────┬──────┘  └──────┬──────┘  │
└─────────┼────────────────┼──────────┘
          │                │
          ▼                ▼
┌─────────────────┐  ┌─────────────────┐
│ デバイスから    │  │ Cloud Run から  │
│ 直接API呼出     │  │ API呼出         │
│                 │  │ (キーはクライアント│
│                 │  │  から送信)      │
└────────┬────────┘  └────────┬────────┘
         │                    │
         └─────────┬──────────┘
                   ▼
         ┌─────────────────┐
         │   Gemini API    │
         │   (無料枠)      │
         │                 │
         │ 1,500件/日     │
         └─────────────────┘
```

### 3.2 処理方式の選択

| 方式 | 処理場所 | メリット | デメリット |
|-----|---------|---------|-----------|
| **A-1: オンデバイス** | iPhone/ブラウザ | サーバー不要、最安 | 60分音声の処理が重い |
| **A-2: クラウド処理** | Cloud Run | 安定処理 | サーバーコスト発生 |

#### 方式A-1: オンデバイス処理（最安）

```
┌─────────────────┐                     ┌─────────────────┐
│  iPhone / Web   │                     │   Gemini API    │
│                 │                     │                 │
│  1. 録音        │                     │                 │
│  2. APIキー取得 │      直接呼出       │                 │
│  3. Gemini呼出  │────────────────────▶│  文字起こし     │
│  4. 結果保存    │◀────────────────────│                 │
│                 │      レスポンス     │                 │
└─────────────────┘                     └─────────────────┘
         │
         ▼
┌─────────────────┐
│  Firebase       │
│  Storage        │
│  (結果保存のみ) │
└─────────────────┘
```

**コスト**: ほぼ$0（Storageのみ）

| 項目 | 月額 |
|-----|------|
| Firebase Storage | $5-10 |
| Gemini API | $0（各ユーザー無料枠） |
| Cloud Run | $0（不使用） |
| **合計** | **$5-10/月** |

**課題**:
- 60分音声のアップロード・処理がデバイス負荷大
- ブラウザのメモリ制限

---

#### 方式A-2: クラウド処理（安定性重視）

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│  iPhone / Web   │         │   Cloud Run     │         │   Gemini API    │
│                 │         │                 │         │                 │
│  1. 録音        │         │                 │         │                 │
│  2. 音声Upload  │────────▶│  3. 音声取得    │         │                 │
│  3. APIキー送信 │────────▶│  4. Gemini呼出  │────────▶│                 │
│                 │         │  5. 結果保存    │         │                 │
│  6. 結果取得    │◀────────│                 │◀────────│                 │
└─────────────────┘         └─────────────────┘         └─────────────────┘
```

**APIキーの送信方法**:
- HTTPヘッダー（`X-Gemini-API-Key`）でCloud Runに送信
- Cloud Runは受け取ったキーでGemini APIを呼び出し
- **キーはCloud Runに保存しない（使い捨て）**

**コスト**:

| 項目 | 月額 |
|-----|------|
| Firebase Storage | $8 |
| Cloud Run | $45-55 |
| Gemini API | $0（各ユーザー無料枠） |
| **合計** | **$53-63/月** |

---

### 3.3 推奨: ハイブリッド方式

| 条件 | 処理方式 |
|-----|---------|
| 音声 ≤ 15分 | **A-1: オンデバイス処理** |
| 音声 > 15分 | **A-2: クラウド処理** |

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ハイブリッド方式                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│  iPhone / Web   │
│                 │
│  録音完了       │
│       │        │
│       ▼        │
│  ┌──────────┐  │
│  │ 音声長   │  │
│  │ 判定     │  │
│  └────┬─────┘  │
│       │        │
│  ┌────┴────┐   │
│  │         │   │
│  ▼         ▼   │
│ ≤15分    >15分 │
│  │         │   │
└──┼─────────┼───┘
   │         │
   ▼         ▼
┌──────┐  ┌──────────┐
│直接  │  │Cloud Run │
│API   │  │経由      │
│呼出  │  │API呼出   │
└──┬───┘  └────┬─────┘
   │           │
   └─────┬─────┘
         ▼
   ┌───────────┐
   │ Gemini    │
   │ API       │
   │ (無料枠)  │
   └───────────┘
```

---

## 4. APIキー入力UI設計

### 4.1 iPhoneアプリ

```
┌─────────────────────────────────────┐
│  ⚙️ 設定                      ✕    │
├─────────────────────────────────────┤
│                                     │
│  Gemini API 設定                    │
│  ─────────────────────────────────  │
│                                     │
│  APIキー                            │
│  ┌─────────────────────────────┐   │
│  │ AIza...                     │   │
│  └─────────────────────────────┘   │
│                                     │
│  [APIキーの取得方法 ↗]              │
│                                     │
│  ┌─────────────────────────────┐   │
│  │       キーを検証            │   │
│  └─────────────────────────────┘   │
│                                     │
│  ステータス: ✅ 有効                │
│  無料枠残り: 1,497 / 1,500 件/日   │
│                                     │
├─────────────────────────────────────┤
│                                     │
│  💡 ヒント                          │
│  Google AI Studio で無料の          │
│  APIキーを取得できます。            │
│  1日1,500件まで無料で利用可能です。 │
│                                     │
└─────────────────────────────────────┘
```

### 4.2 Webアプリ

```
┌─────────────────────────────────────────────────────────────────┐
│  ⚙️ 設定                                                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Gemini API 設定                                                │
│  ───────────────────────────────────────────────────────────    │
│                                                                 │
│  APIキー                                                        │
│  ┌───────────────────────────────────────────────────────┐     │
│  │ AIzaSy...                                       👁️    │     │
│  └───────────────────────────────────────────────────────┘     │
│                                                                 │
│  [APIキーの取得方法を見る]                                      │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐                              │
│  │   検証      │  │   保存      │                              │
│  └─────────────┘  └─────────────┘                              │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ✅ APIキーは有効です                                    │   │
│  │ 無料枠: 1,500件/日 | 本日使用: 3件                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ⚠️ セキュリティについて                                       │
│  APIキーはブラウザに暗号化して保存されます。                    │
│  共有PCでの利用はお控えください。                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 APIキー取得手順（ユーザー向けガイド）

```
┌─────────────────────────────────────────────────────────────────┐
│  📖 Gemini APIキーの取得方法                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1: Google AI Studio にアクセス                            │
│  ────────────────────────────────────                           │
│  https://aistudio.google.com/ を開く                            │
│                                                                 │
│  Step 2: Googleアカウントでログイン                             │
│  ────────────────────────────────────                           │
│  会社のGoogleアカウントでログインしてください                   │
│                                                                 │
│  Step 3: APIキーを作成                                          │
│  ────────────────────────────────────                           │
│  左メニュー「Get API Key」→「Create API Key」                   │
│                                                                 │
│  Step 4: キーをコピー                                           │
│  ────────────────────────────────────                           │
│  表示されたキー（AIzaSy...）をコピー                            │
│                                                                 │
│  Step 5: アプリに貼り付け                                       │
│  ────────────────────────────────────                           │
│  設定画面のAPIキー欄に貼り付けて保存                            │
│                                                                 │
│  💡 無料枠: 1日1,500リクエストまで無料                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 5. セキュリティ対策

### 5.1 iPhoneアプリ

| 対策 | 実装方法 |
|-----|---------|
| **暗号化保存** | iOS Keychain に保存（AES-256暗号化） |
| **生体認証** | Face ID/Touch ID で設定画面をロック（オプション） |
| **メモリ保護** | APIキーは使用後すぐにメモリから削除 |

```swift
// Keychain保存例
let query: [String: Any] = [
    kSecClass as String: kSecClassGenericPassword,
    kSecAttrAccount as String: "gemini_api_key",
    kSecValueData as String: apiKey.data(using: .utf8)!,
    kSecAttrAccessible as String: kSecAttrAccessibleWhenUnlockedThisDeviceOnly
]
SecItemAdd(query as CFDictionary, nil)
```

### 5.2 Webアプリ

| 対策 | 実装方法 |
|-----|---------|
| **暗号化保存** | Web Crypto API で暗号化 → IndexedDB 保存 |
| **HTTPS必須** | HTTP環境では動作しない設計 |
| **セッション管理** | ブラウザ閉じたらメモリからキー削除 |

```javascript
// Web Crypto API で暗号化保存
async function encryptAndStore(apiKey) {
  const key = await crypto.subtle.generateKey(
    { name: 'AES-GCM', length: 256 },
    true,
    ['encrypt', 'decrypt']
  );
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv },
    key,
    new TextEncoder().encode(apiKey)
  );
  // IndexedDBに保存
}
```

### 5.3 Cloud Run（方式A-2の場合）

| 対策 | 実装方法 |
|-----|---------|
| **キー非保存** | 受信したAPIキーはメモリ上のみ、処理後即破棄 |
| **ログ除外** | APIキーをログに出力しない |
| **HTTPS** | Cloud Runは標準でHTTPS |

---

## 6. コスト比較

### 6.1 v3 vs v4 コスト比較

| 項目 | v3 | v4 (A-1) | v4 (A-2) | v4 (ハイブリッド) |
|-----|----|---------|---------|--------------------|
| Firebase Storage | $8 | $5 | $8 | $6 |
| Cloud Run | $66 | $0 | $50 | $25 |
| Gemini API | $19-56 | **$0** | **$0** | **$0** |
| **月額合計** | **$93-130** | **$5** | **$58** | **$31** |
| **年額** | $1,116-1,560 | **$60** | **$696** | **$372** |

### 6.2 コスト削減効果

| 比較 | v3 | v4 (ハイブリッド) | 削減率 |
|-----|----|--------------------|-------|
| 月額 | $93-130 | $31 | **70-76%削減** |
| 年額 | $1,116-1,560 | $372 | **70-76%削減** |

---

## 7. 実装フェーズ

### 7.1 Phase 1: 基盤構築（1週間）

```
1. Firebase プロジェクト設定
2. Firebase Storage 設定
3. Cloud Run サービス作成（ハイブリッド用）
4. APIキー受け渡しのAPI設計
```

### 7.2 Phase 2: iPhoneアプリ（2週間）

```
1. 設定画面UI作成
2. Keychain保存機能
3. APIキー検証機能
4. オンデバイス処理（≤15分）
5. Cloud Run連携（>15分）
6. 結果表示
```

### 7.3 Phase 3: Webアプリ（3週間）

```
1. React/Next.js プロジェクト作成
2. 設定画面UI作成
3. 暗号化保存機能（Web Crypto API）
4. オンデバイス処理（≤15分）
5. Cloud Run連携（>15分）
6. 結果表示
```

### 7.4 Phase 4: ドキュメント・オンボーディング（3日）

```
1. APIキー取得ガイド作成
2. アプリ内ヘルプ作成
3. 初回起動時チュートリアル
```

---

## 8. リスクと対策

### 8.1 リスク一覧

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| ユーザーがAPIキー取得に失敗 | 高 | 中 | 詳細ガイド + アプリ内ヘルプ |
| Google無料枠の変更 | 高 | 低 | 定期的なポリシー確認、代替API検討 |
| APIキー漏洩 | 高 | 低 | Keychain/暗号化、ユーザー教育 |
| オンデバイス処理の負荷 | 中 | 中 | 15分以上はCloud Run利用 |

### 8.2 無料枠変更時の対応

| シナリオ | 対応策 |
|---------|-------|
| 無料枠縮小 | 1. 通知でユーザーに周知 2. 有料プラン検討を促す |
| 無料枠廃止 | 1. サービス側でAPIキー一括管理に移行 2. 料金プラン導入 |

---

## 9. 総合評価

### 9.1 v4評価マトリクス

| 項目 | 重み | v3 | v4 (ハイブリッド) |
|-----|-----|----|--------------------|
| コスト | 30% | 3 | 5 |
| セキュリティ | 20% | 5 | 4 |
| UX | 20% | 5 | 3 |
| 実装難度 | 15% | 4 | 4 |
| 運用負荷 | 15% | 4 | 4 |
| **合計** | 100% | **4.05** | **4.1** |

### 9.2 v4の適合ケース

| ケース | v3推奨 | v4推奨 |
|-------|-------|-------|
| コスト最優先 | | ✅ |
| UX最優先 | ✅ | |
| 技術リテラシー高いユーザー | | ✅ |
| 一般消費者向け | ✅ | |
| 企業内営業チーム向け | | ✅ |

---

## 10. 結論

### 10.1 最終推奨

| 項目 | 推奨 |
|-----|------|
| **アーキテクチャ** | ハイブリッド方式（オンデバイス + Cloud Run） |
| **APIキー管理** | クライアント保存（Keychain / 暗号化） |
| **処理分岐** | ≤15分: オンデバイス / >15分: Cloud Run |
| **月額コスト** | **$31/月**（v3比 70%削減） |

### 10.2 v1-v4 比較サマリー

| バージョン | 推奨構成 | 月額コスト | 主な特徴 |
|-----------|---------|-----------|---------|
| v1 | Firebase + Cloud Functions | $26-61 | 20分音声、iPhoneのみ |
| v2 | Firebase + Cloud Run | $93-130 | 60分音声、iPhone+Web |
| v3 | Firebase + Cloud Run | $93-130 | iPhone/Web別開発 |
| **v4** | **ハイブリッド + ユーザーAPIキー** | **$31** | **無料枠活用、70%コスト削減** |

### 10.3 次のステップ

1. Gemini API 無料枠の最新仕様確認
2. APIキー入力UIのプロトタイプ作成
3. ユーザー向けAPIキー取得ガイド作成
4. Phase 1-4 の実装開始

---

**以上**
