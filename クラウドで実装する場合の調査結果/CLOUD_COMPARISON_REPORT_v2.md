# クラウドサービス比較検討レポート v2

**作成日**: 2026-01-06
**更新日**: 2026-01-06
**目的**: ボイスメモ文字起こしシステムの最適なクラウド構成を選定

---

## 1. 要件サマリー（改訂版）

### 1.1 利用規模

| 年度 | ユーザー数 | 月間音声時間 | 月間ファイル数 | 1件あたり |
|-----|----------|------------|--------------|----------|
| 2026年 | 31名 | 3,100時間 | **約3,100件** | 60分 |
| 2027年 | 68名 | 6,800時間 | **約6,800件** | 60分 |

### 1.2 デバイス構成

| デバイス | 比率 | 月間ファイル数(2026) | クライアント形態 |
|---------|-----|---------------------|-----------------|
| iPhone | 50% | 1,550件 | ネイティブアプリ |
| PC | 50% | 1,550件 | **Webアプリ（ブラウザ）** |

### 1.3 技術要件

| 項目 | 要件 |
|-----|------|
| 音声フォーマット | m4a/webm（1件あたり **約60分**、約30-100MB） |
| 文字起こしAPI | Gemini API（既存実装） |
| 処理時間 | **60分音声 → 約5-15分処理** |
| 結果保存 | JSON形式（構造化テキスト） |

### 1.4 v1からの主な変更点

| 項目 | v1 | v2 |
|-----|----|----|
| 1商談の録音時間 | 20分 | **60分** |
| 月間ファイル数(2026) | 15,500件 | **3,100件** |
| クライアント | iPhoneのみ | **iPhone + Webブラウザ** |
| 1ファイルサイズ | 10-30MB | **30-100MB** |

---

## 2. 要件変更による技術的影響

### 2.1 処理時間の重要性が大幅上昇

| サービス | タイムアウト上限 | 60分音声処理 | 評価 |
|---------|----------------|-------------|------|
| Cloud Functions (2nd gen) | 9分 | ❌ 不可 | **除外** |
| Firebase Functions | 9分 | ❌ 不可 | **除外** |
| AWS Lambda | 15分 | ⚠️ ギリギリ | 要検証 |
| **Cloud Run** | **60分** | ✅ 余裕 | **推奨** |
| Azure Functions (Premium) | 無制限 | ✅ 可 | 検討可 |
| Cloudflare Workers | 15分(Paid) | ⚠️ 厳しい | 除外 |

> **結論**: Cloud Functions / Firebase Functions は60分音声処理に**不適合**。Cloud Run または AWS Lambda が現実的。

### 2.2 Webクライアント追加の影響

| 観点 | iPhone専用 | iPhone + Web |
|-----|-----------|--------------|
| SDK選定 | Firebase iOS SDK最適 | **マルチプラットフォーム対応必要** |
| 認証 | Firebase Auth (iOS) | Firebase Auth (iOS + Web) |
| アップロード | Firebase Storage SDK | Firebase Storage SDK (両対応) |
| API設計 | SDK依存OK | **REST API必要性上昇** |

> **結論**: Webクライアント追加により、Firebase の優位性は維持しつつ、REST API対応が必要。

---

## 3. クラウドサービス再評価

### 3.1 全体比較表（改訂版）

| プロバイダー | 構成 | 60分処理 | 月額(2026) | 月額(2027) | Web対応 | 実装難度 |
|------------|------|---------|-----------|-----------|---------|---------|
| ~~GCP Cloud Functions~~ | ~~Storage + Functions~~ | ❌ | - | - | - | - |
| ~~Firebase Functions~~ | ~~Storage + Functions~~ | ❌ | - | - | - | - |
| **GCP Cloud Run** | Storage + Run | ✅ | $60-100 | $120-200 | ◎ | ○ 中 |
| **Firebase + Cloud Run** | Firebase Storage + Run | ✅ | $50-90 | $100-180 | ◎ | ○ 中 |
| **AWS Lambda** | S3 + Lambda | ⚠️ | $40-70 | $80-140 | ◎ | ○ 中 |
| AWS ECS Fargate | S3 + Fargate | ✅ | $80-150 | $160-280 | ◎ | △ 高 |
| Azure Functions Premium | Blob + Functions | ✅ | $70-120 | $140-240 | ◎ | ○ 中 |

### 3.2 除外サービス

| サービス | 除外理由 |
|---------|---------|
| GCP Cloud Functions | 9分タイムアウト → 60分音声処理不可 |
| Firebase Functions | 同上 |
| Cloudflare Workers | 15分制限 + 長時間処理の実績少 |

---

## 4. 有力候補の詳細分析

### 4.1 【推奨】Firebase Storage + Cloud Run

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           推奨アーキテクチャ v2                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐         ┌─────────────────────────────────────┐
│    iPhone       │         │                                     │
│  VoiceMemoApp   │         │      Firebase Storage               │
│                 │────────▶│                                     │
│  Firebase SDK   │         │  📁 audio/{userId}/                 │
└─────────────────┘         │     └── 2026-01-05_143022.m4a      │
                            │                                     │
┌─────────────────┐         │                                     │
│    PC Browser   │         │                                     │
│  Web App        │────────▶│                                     │
│                 │         │                                     │
│  Firebase SDK   │         └──────────────────┬──────────────────┘
└─────────────────┘                            │
                                               │ Eventarc トリガー
                                               ▼
                            ┌─────────────────────────────────────┐
                            │           Cloud Run                  │
                            │                                      │
                            │  • タイムアウト: 最大60分            │
                            │  • 60分音声 → 5-15分で処理           │
                            │  • Gemini API 呼び出し               │
                            │  • 結果をStorage保存                 │
                            │                                      │
                            └──────────────────┬──────────────────┘
                                               │
                                               ▼
                            ┌─────────────────────────────────────┐
                            │      Firebase Storage                │
                            │                                      │
                            │  📁 transcripts/{userId}/            │
                            │     └── 2026-01-05_143022.json      │
                            └─────────────────────────────────────┘
```

#### コスト詳細（2026年: 3,100件/月、60分/件）

| 項目 | 単価 | 使用量 | 月額 |
|-----|------|-------|------|
| Firebase Storage | $0.026/GB | 300GB | $7.8 |
| Cloud Run (CPU) | $0.00002400/vCPU-秒 | 1vCPU × 600秒 × 3,100 | $44.6 |
| Cloud Run (メモリ) | $0.00000250/GB-秒 | 2GB × 600秒 × 3,100 | $9.3 |
| Eventarc | $0.10/100万 | 3,100 | $0.0003 |
| Egress | $0.12/GB | 100GB | $12 |
| **インフラ小計** | | | **$74** |
| Gemini API | $0.01-0.03/分 | 3,100時間 | $19-56 |
| **合計** | | | **$93-130/月** |

#### メリット

| 項目 | 詳細 |
|-----|------|
| **60分処理対応** | Cloud Run は最大60分タイムアウト |
| **マルチプラットフォーム** | Firebase SDK は iOS / Web 両対応 |
| **Gemini統合** | 同一GCPプロジェクトで認証シームレス |
| **認証統一** | Firebase Auth で iPhone / Web 両方カバー |
| **スケーラビリティ** | Cloud Run 自動スケール |
| **イベント駆動** | Eventarc でアップロード検知 → 自動処理 |

#### デメリット

| 項目 | 対策 |
|-----|------|
| Cloud Functions より高コスト | ファイル数減少(3,100件)で相殺 |
| コンテナ管理の知識必要 | Dockerfileテンプレート活用 |

---

### 4.2 AWS S3 + Lambda

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│  iPhone / Web   │         │       S3        │ S3イベント│      SQS       │
│                 │────────▶│  (音声保存)     │────────▶│  (キュー)      │
└─────────────────┘  SDK    └─────────────────┘         └────────┬────────┘
                                                                 │
                                                                 ▼
                                                        ┌─────────────────┐
                                                        │     Lambda      │
                                                        │  (15分制限)     │
                                                        └─────────────────┘
```

#### コスト詳細（2026年）

| 項目 | 単価 | 使用量 | 月額 |
|-----|------|-------|------|
| S3 Standard | $0.023/GB | 300GB | $6.9 |
| Lambda (実行) | $0.0000166667/GB-秒 | 2GB × 600秒 × 3,100 | $62 |
| SQS | $0.40/100万 | 3,100 | $0.001 |
| **インフラ小計** | | | **$69** |
| Gemini API | | | $19-56 |
| **合計** | | | **$88-125/月** |

#### リスク

| リスク | 影響度 | 対策 |
|-------|-------|------|
| **15分タイムアウト** | 高 | 60分音声が15分で処理完了するか要検証 |
| Gemini API認証 | 中 | Secrets Managerでキー管理 |

> **注意**: Lambda 15分制限は60分音声処理にギリギリ。Gemini APIのレスポンス時間次第でタイムアウトリスクあり。

---

### 4.3 AWS S3 + ECS Fargate

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│  iPhone / Web   │         │       S3        │ EventBridge│ ECS Fargate   │
│                 │────────▶│                 │────────▶│  (コンテナ)    │
└─────────────────┘         └─────────────────┘         └─────────────────┘
```

#### コスト詳細（2026年）

| 項目 | 単価 | 使用量 | 月額 |
|-----|------|-------|------|
| S3 | $0.023/GB | 300GB | $6.9 |
| Fargate (vCPU) | $0.04048/vCPU-時間 | 0.5vCPU × 0.17時間 × 3,100 | $10.7 |
| Fargate (メモリ) | $0.004445/GB-時間 | 1GB × 0.17時間 × 3,100 | $2.3 |
| **インフラ小計** | | | **$20** |
| Gemini API | | | $19-56 |
| **合計** | | | **$39-76/月** |

#### メリット・デメリット

| メリット | デメリット |
|---------|-----------|
| タイムアウトなし | ECSクラスタ管理が複雑 |
| 最安コスト | AWSの深い知識必要 |
| スケール自在 | Gemini連携に一手間 |

---

### 4.4 Azure Functions Premium

#### コスト詳細（2026年）

| 項目 | 単価 | 使用量 | 月額 |
|-----|------|-------|------|
| Blob Storage | $0.0184/GB | 300GB | $5.5 |
| Functions Premium (EP1) | $0.173/時間 | 推定稼働時間 | $60-100 |
| **インフラ小計** | | | **$66-106** |
| Gemini API | | | $19-56 |
| **合計** | | | **$85-162/月** |

#### 評価

| 項目 | 評価 |
|-----|------|
| 60分処理 | ✅ Premium プランでタイムアウトなし |
| Gemini親和性 | △ GCP系と比べてメリットなし |
| SDK | △ iOS/Web SDK は Firebase に劣る |

---

## 5. 総合評価（改訂版）

### 5.1 評価マトリクス

| 項目 | 重み | Firebase+Run | AWS Lambda | AWS Fargate | Azure Premium |
|-----|-----|--------------|-----------|-------------|---------------|
| **60分処理対応** | 30% | 5 | 3 | 5 | 5 |
| Gemini親和性 | 20% | 5 | 3 | 3 | 2 |
| マルチプラットフォーム | 15% | 5 | 4 | 4 | 3 |
| コスト | 15% | 3 | 4 | 5 | 3 |
| 実装シンプルさ | 10% | 4 | 4 | 2 | 3 |
| スケーラビリティ | 10% | 5 | 4 | 5 | 4 |
| **合計** | 100% | **4.45** | **3.55** | **3.95** | **3.35** |

### 5.2 ランキング

| 順位 | サービス | スコア | 推奨理由 |
|-----|---------|-------|---------|
| 1 | **Firebase + Cloud Run** | 4.45 | 60分処理OK、マルチプラットフォーム、Gemini統合最適 |
| 2 | AWS S3 + ECS Fargate | 3.95 | 最安だが実装複雑 |
| 3 | AWS S3 + Lambda | 3.55 | 15分制限がリスク |
| 4 | Azure Functions Premium | 3.35 | 特別なメリットなし |

---

## 6. 推奨構成

### 6.1 最終推奨: Firebase Storage + Cloud Run

| 項目 | 内容 |
|-----|------|
| **音声ストレージ** | Firebase Storage (Cloud Storage for Firebase) |
| **処理エンジン** | Cloud Run (タイムアウト60分) |
| **イベント連携** | Eventarc (Storage → Cloud Run) |
| **認証** | Firebase Auth (iOS / Web 共通) |
| **文字起こし** | Gemini API |
| **結果保存** | Firebase Storage (JSON) |

### 6.2 コスト見積もり

| 年度 | インフラ | Gemini API | 合計 |
|-----|---------|-----------|------|
| 2026年 | $74/月 | $19-56/月 | **$93-130/月** |
| 2027年 | $148/月 | $38-112/月 | **$186-260/月** |

### 6.3 選定理由

| 理由 | 詳細 |
|-----|------|
| **60分音声対応** | Cloud Run 最大60分タイムアウトで余裕 |
| **マルチプラットフォーム** | Firebase SDK が iOS / Web 両対応 |
| **Gemini統合** | 同一GCPプロジェクトで認証シームレス |
| **認証統一** | Firebase Auth で両クライアント対応 |
| **イベント駆動** | アップロード検知 → 自動処理 |
| **将来拡張** | Cloud Run は他の処理（要約、分析等）も追加容易 |

---

## 7. クライアント別実装方針

### 7.1 iPhoneアプリ

| 項目 | 技術選定 |
|-----|---------|
| フレームワーク | SwiftUI |
| Firebase SDK | FirebaseStorage, FirebaseAuth |
| アップロード | resumable upload（大容量対応） |
| 状態管理 | アップロード進捗表示 |

### 7.2 Webアプリ（PCブラウザ）

| 項目 | 技術選定 |
|-----|---------|
| フレームワーク | React / Next.js（推奨） |
| Firebase SDK | firebase/storage, firebase/auth |
| 録音 | MediaRecorder API (WebM形式) |
| アップロード | resumable upload |

### 7.3 音声フォーマット

| デバイス | 形式 | 理由 |
|---------|-----|------|
| iPhone | m4a (AAC) | iOS標準、高圧縮 |
| Web | webm (Opus) | ブラウザ標準、高圧縮 |

> **注意**: Cloud Run側で両形式に対応する処理が必要。Gemini APIは両形式対応。

---

## 8. 実装フェーズ

### Phase 1: Firebase + Cloud Run セットアップ

```
1. Firebase Console でプロジェクト作成
2. Cloud Storage for Firebase 有効化
3. Firebase Auth 有効化（Email/Password or Google）
4. Cloud Run サービス作成
5. Eventarc で Storage → Cloud Run トリガー設定
```

### Phase 2: Cloud Run 処理エンジン実装

```
1. Dockerfile 作成
2. 音声取得 → Gemini API → 結果保存 の処理実装
3. m4a / webm 両形式対応
4. エラーハンドリング・リトライ処理
5. デプロイ・テスト
```

### Phase 3: iPhoneアプリ改修

```
1. Firebase iOS SDK 追加
2. Firebase Auth 実装
3. Firebase Storage アップロード実装
4. 進捗表示UI
```

### Phase 4: Webアプリ新規開発

```
1. React/Next.js プロジェクト作成
2. Firebase Web SDK 統合
3. 録音機能（MediaRecorder API）
4. アップロード機能
5. 結果表示UI
```

---

## 9. 代替案

### 9.1 AWS完結構成（コスト重視）

Firebase + Cloud Run がコスト面で懸念される場合:

| 構成 | 月額(2026) | メリット | デメリット |
|-----|-----------|---------|-----------|
| S3 + ECS Fargate | $39-76 | 最安 | 実装複雑、Gemini連携に一手間 |

### 9.2 ハイブリッド構成

| 構成 | 用途 |
|-----|------|
| Firebase Auth + Storage | クライアント認証・アップロード |
| AWS Lambda / Fargate | 処理エンジン（コスト削減） |

> **注意**: 複雑になるため、初期は Firebase + Cloud Run 統一を推奨。

---

## 10. 結論

### 最終推奨

| 優先度 | 構成 | 用途 |
|-------|------|------|
| **第1推奨** | Firebase Storage + Cloud Run | **60分音声 + iPhone/Web 両対応** |
| 第2推奨 | AWS S3 + ECS Fargate | コスト最優先（実装複雑を許容） |

### v1からの変更サマリー

| 項目 | v1 | v2 |
|-----|----|----|
| 推奨構成 | Firebase + Cloud Functions | **Firebase + Cloud Run** |
| 変更理由 | - | **60分音声処理にFunctionsは不適合** |
| 月額コスト | $26-61 | **$93-130** |
| コスト増加理由 | - | Cloud Run採用 + ファイルサイズ増 |

### 次のステップ

1. Firebase プロジェクト作成
2. Cloud Run サービス構築
3. Eventarc トリガー設定
4. iPhoneアプリ改修
5. Webアプリ新規開発

---

**以上**
