# アーキテクチャ決定事項

**作成日**: 2026-01-09
**最終更新**: 2026-01-09
**ステータス**: ✅ アーキテクチャ策定完了

---

## 1. エグゼクティブサマリー

### 1.1 システム概要

ボイスメモアプリは、iPhone/Web/将来のAndroidから録音を行い、AI文字起こし・構造化を経て、SFA/CRMシステムと連携する**マルチプラットフォーム音声処理プラットフォーム**である。

### 1.2 アーキテクチャ方針

**「Cloud Run First + 段階的拡張」**

- サーバーレス（Cloud Run）でスモールスタート
- 5フェーズで段階的に機能拡張
- 将来のGKE移行パスを確保

### 1.3 主要決定事項

| 項目 | 決定内容 |
|------|---------|
| **クラウド** | Google Cloud Platform |
| **コンピューティング** | Cloud Run（サーバーレス） |
| **フロントエンド** | Swift (iOS) + React PWA (Web) |
| **バックエンド** | Python FastAPI |
| **AI** | Gemini 2.5 Flash |
| **データベース** | Firestore + GCS + Chroma Cloud |
| **連携方式** | REST API + Webhook |

---

## 2. 全体アーキテクチャ

### 2.1 システム構成図

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                             ボイスメモ システム構成                                    │
│                                                                                     │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                          クライアント層                                       │    │
│  │   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐              │    │
│  │   │  iPhone     │      │   Web App   │      │  (将来)      │              │    │
│  │   │  App        │      │  (PWA)      │      │  Android    │              │    │
│  │   │  [Swift]    │      │  [React]    │      │             │              │    │
│  │   └──────┬──────┘      └──────┬──────┘      └──────┬──────┘              │    │
│  └──────────┼────────────────────┼────────────────────┼──────────────────────┘    │
│             └────────────────────┼────────────────────┘                           │
│                                  │ HTTPS                                          │
│                                  ▼                                                │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                         Google Cloud Platform                               │    │
│  │                                                                            │    │
│  │   ┌──────────────────────────────────────────────────────────────────┐    │    │
│  │   │                      API Gateway (Cloud Run)                     │    │    │
│  │   │                 JWT認証 / ルーティング / レート制限                │    │    │
│  │   └──────────────────────────────┬───────────────────────────────────┘    │    │
│  │                                  │                                        │    │
│  │   ┌──────────────────────────────┼──────────────────────────────┐        │    │
│  │   │                              │                              │        │    │
│  │   ▼                              ▼                              ▼        │    │
│  │   ┌───────────┐           ┌───────────┐           ┌───────────┐          │    │
│  │   │ Recording │           │Transcription           │  Storage  │          │    │
│  │   │ Service   │──────────▶│ Service   │──────────▶│  Service  │          │    │
│  │   └───────────┘           └─────┬─────┘           └─────┬─────┘          │    │
│  │                                 │                       │                │    │
│  │                                 ▼                       │                │    │
│  │                          ┌───────────┐                  │                │    │
│  │                          │  Search   │◀─────────────────┘                │    │
│  │                          │  Service  │                                   │    │
│  │                          └─────┬─────┘                                   │    │
│  │                                │                                         │    │
│  │   ┌────────────────────────────┼────────────────────────────────────┐    │    │
│  │   │                    Cloud Pub/Sub (イベント駆動)                   │    │    │
│  │   └────────────────────────────┬────────────────────────────────────┘    │    │
│  │                                │                                         │    │
│  │                          ┌─────▼─────┐                                   │    │
│  │                          │   CRM     │                                   │    │
│  │                          │  Gateway  │                                   │    │
│  │                          └─────┬─────┘                                   │    │
│  └────────────────────────────────┼─────────────────────────────────────────┘    │
│                                   │ REST + Webhook                               │
│                                   ▼                                              │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Revenue Intelligence Platform (SFA/CRM)                  │    │
│  └────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 データストア構成

| ストア | 用途 | 技術 |
|--------|------|------|
| **音声ファイル** | 録音データ保存 | Cloud Storage (GCS) |
| **メタデータ** | 録音情報、処理状態 | Firestore |
| **ベクトル** | セマンティック検索 | Chroma Cloud |
| **シークレット** | APIキー、認証情報 | Secret Manager |

---

## 3. 技術スタック

### 3.1 フロントエンド

| カテゴリ | 技術 | 備考 |
|---------|------|------|
| **iOS** | Swift 6 + SwiftUI | ネイティブアプリ |
| **iOS データ** | SwiftData | ローカル永続化 |
| **Web** | React 19 + TypeScript | PWA対応 |
| **Web 状態管理** | Zustand | 軽量 |
| **Web 録音** | MediaRecorder API | ブラウザ標準 |
| **Web ビルド** | Vite 6 | 高速ビルド |

### 3.2 バックエンド

| カテゴリ | 技術 | 備考 |
|---------|------|------|
| **言語** | Python 3.13+ | 最新 |
| **フレームワーク** | FastAPI 0.115+ | 非同期対応 |
| **バリデーション** | Pydantic 2.x | 型安全 |
| **サーバー** | Uvicorn | ASGI |

### 3.3 AI/ML

| 用途 | 技術 | モデル |
|------|------|--------|
| **文字起こし** | Gemini Audio API | Gemini 2.5 Flash |
| **構造化・要約** | Gemini API | Gemini 2.5 Flash |
| **エンベディング** | ChromaDB | text-embedding-3-small |

### 3.4 インフラストラクチャ

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| **コンピューティング** | Cloud Run | 全サービス |
| **メッセージング** | Cloud Pub/Sub | 非同期イベント |
| **ストレージ** | GCS | 音声ファイル |
| **データベース** | Firestore | メタデータ |
| **ベクトルDB** | Chroma Cloud | 検索 |
| **認証** | Firebase Auth | ユーザー認証 |

### 3.5 DevOps

| カテゴリ | 技術 |
|---------|------|
| **CI** | GitHub Actions |
| **CD** | Cloud Build |
| **モニタリング** | Cloud Monitoring + Cloud Trace |
| **ロギング** | Cloud Logging |
| **コンテナ** | Artifact Registry |

---

## 4. マイクロサービス構成

### 4.1 サービス一覧

| サービス | 責務 | 技術 | データストア |
|---------|------|------|------------|
| **API Gateway** | 認証・ルーティング | Cloud Run | - |
| **Recording Service** | 録音受付 | Cloud Run | GCS |
| **Transcription Service** | 文字起こし | Cloud Run + Gemini | - |
| **Storage Service** | データ管理 | Cloud Run | Firestore |
| **Search Service** | 検索機能 | Cloud Run | Chroma Cloud |
| **CRM Gateway** | SFA/CRM連携 | Cloud Run | - |

### 4.2 通信方式

| 通信 | 方式 | プロトコル |
|------|------|----------|
| **外部→内部** | REST | HTTPS/JSON |
| **内部同期** | REST（将来gRPC） | HTTP/JSON |
| **内部非同期** | Pub/Sub | イベント |
| **CRM連携** | REST + Webhook | HTTPS/JSON |

### 4.3 認証方式

| フェーズ | 方式 | 対象 |
|---------|------|------|
| **Phase 1-2** | API Key | 内部サービス間 |
| **Phase 2-3** | JWT | ユーザー認証 |
| **Phase 4+** | OAuth 2.0 | 外部連携 |

---

## 5. 実装ロードマップ

### 5.1 フェーズ概要

| フェーズ | 期間 | 内容 | 成果物 |
|---------|------|------|--------|
| **Phase 1** | 2026 Q1 | iOS基盤構築 | iPhoneアプリ完成 |
| **Phase 2** | 2026 Q2 | クラウド移行 | GCPデプロイ完了 |
| **Phase 3** | 2026 Q3 | Web版開発 | PWAリリース |
| **Phase 4** | 2026 Q4 | CRM連携 | SFA/CRM統合 |
| **Phase 5** | 2027 Q1+ | 最適化 | パフォーマンス改善 |

### 5.2 Phase 1: iOS基盤構築（現在進行中）

| タスク | 状態 |
|--------|------|
| SwiftData導入 | ⬜ 未着手 |
| KeychainService | ✅ 完了 |
| 設定画面 | ⬜ 未着手 |
| 録音機能 | ⬜ 未着手 |
| Mac連携テスト | ⬜ 未着手 |

### 5.3 Phase 2: クラウド移行

| タスク | 内容 |
|--------|------|
| GCP設定 | プロジェクト、IAM、ネットワーク |
| Cloud Run | Transcription/Storage/Search Service |
| データストア | GCS、Firestore、Chroma Cloud |
| モニタリング | Cloud Trace、Cloud Monitoring |

### 5.4 Phase 3: Web版開発

| タスク | 内容 |
|--------|------|
| React設定 | Vite + TypeScript + PWA |
| 録音機能 | MediaRecorder API |
| 認証統合 | Firebase Auth |
| オフライン | Service Worker、IndexedDB |

### 5.5 Phase 4: CRM連携

| タスク | 内容 |
|--------|------|
| CRM Gateway | Webhook受信、データ変換 |
| API v2 | revenue-intelligence-platform拡張 |
| エラー処理 | リトライ、Circuit Breaker |

---

## 6. コスト見積もり

### 6.1 月額コスト

| 規模 | ユーザー数 | 月額目安 |
|------|----------|---------|
| **初期** | 10人 | $16-64 |
| **成長期** | 50人 | $108-301 |
| **本格運用** | 200人 | $482-1,265 |

### 6.2 主要コスト内訳

| サービス | 初期 | 成長期 | 本格運用 |
|---------|------|-------|---------|
| Cloud Run | $5-20 | $30-80 | $100-300 |
| GCS | $1-2 | $5-10 | $20-30 |
| Gemini API | $10-30 | $50-150 | $200-600 |
| その他 | $0-12 | $23-61 | $162-335 |

### 6.3 初期クレジット

- **GCP新規アカウント**: $300クレジット（6-18ヶ月分相当）

---

## 7. リスクと対策

### 7.1 高優先度リスク

| リスク | 対策 |
|--------|------|
| Gemini API障害 | OpenAI Whisperフォールバック準備 |
| データ不整合 | 冪等性キー必須、Sagaパターン検討 |
| セキュリティ | WAF、IAM最小権限、定期脆弱性スキャン |
| コスト急増 | 予算アラート、利用量上限設定 |

### 7.2 中優先度リスク

| リスク | 対策 |
|--------|------|
| コールドスタート | 最小インスタンス=1、ウォームアップ |
| Safari互換性 | ポリフィル準備、WAVサポート |
| ChromaDB限界 | シャーディング計画、Pinecone検討 |

---

## 8. 残課題

### 8.1 高優先度

| 課題 | 対応時期 |
|------|---------|
| API Gateway実装方式 | Phase 2 |
| Gemini APIコスト詳細検証 | Phase 2 |
| Safari互換性テスト | Phase 3 |
| Webhook署名検証 | Phase 4 |

### 8.2 中優先度

| 課題 | 対応時期 |
|------|---------|
| サービス間認証詳細設計 | Phase 2 |
| コールドスタート対策 | Phase 2 |
| React状態管理選定 | Phase 3 |
| レート制限設計 | Phase 4 |

---

## 9. 関連ドキュメント

### 9.1 調査ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [01_multiplatform.md](./01_multiplatform.md) | マルチプラットフォーム対応 |
| [02_server_migration.md](./02_server_migration.md) | サーバー移行計画 |
| [03_sfa_crm_integration.md](./03_sfa_crm_integration.md) | SFA/CRM連携 |
| [04_microservices.md](./04_microservices.md) | マイクロサービス設計 |
| [05_integrated_architecture.md](./05_integrated_architecture.md) | 統合アーキテクチャ |

### 9.2 実装ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| PHASE1_PLAN.md | Phase 1詳細プラン |
| CLAUDE.md | プロジェクト指示 |
| RESEARCH_PLAN.md | 調査プラン |

---

## 10. 次のアクション

1. **Phase 1 継続**: iOS基盤構築（SwiftData、設定画面、録音機能）
2. **Phase 2 準備**: GCPプロジェクト設定、Cloud Run検証
3. **アーキテクチャレビュー**: 本ドキュメントの定期見直し

---

**更新履歴:**
- 2026-01-09: 初版作成
- 2026-01-09: 統合アーキテクチャ策定完了、全テーマ調査結果統合
