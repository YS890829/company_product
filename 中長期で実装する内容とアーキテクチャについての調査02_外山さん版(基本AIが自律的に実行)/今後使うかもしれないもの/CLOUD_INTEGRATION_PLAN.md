# Cloud Integration Plan - ボイスメモ自動文字起こしシステム

**作成日**: 2026-01-05
**バージョン**: 2.0

---

## 1. 概要

### 1.1 目的

iPhoneで録音した音声を自動的にGoogle Driveへ保存し、Macが検知して文字起こし・構造化処理を行う。

### 1.2 設計方針

**シンプルさ最優先** - 独自APIサーバー不要、標準機能を最大活用

### 1.3 スコープ

| 対象 | 内容 |
|-----|------|
| 音声録音 | 既存のsimple_voicememo_iphoneapp |
| クラウド保存 | Google Drive（iOSアプリから直接） |
| ファイル検知 | Google Drive Push Notifications（Webhook） |
| 文字起こし | 既存のstructured_transcriber（Gemini API） |

---

## 2. システムアーキテクチャ

### 2.1 全体構成図

```
┌─────────────────┐
│    iPhone       │
│  VoiceMemoApp   │
│                 │
│  ┌───────────┐  │
│  │  録音     │  │
│  │  m4a保存  │  │
│  └─────┬─────┘  │
│        │        │
│  ┌─────▼─────┐  │          ┌─────────────────────────────────────┐
│  │ Google    │  │  自動    │            Google Drive              │
│  │ Drive SDK │──┼─────────▶│                                     │
│  │ Upload    │  │  同期    │  📁 VoiceMemo/audio/                │
│  └───────────┘  │          │     ├── 2026-01-05_143022.m4a      │
└─────────────────┘          │     └── 2026-01-05_150511.m4a      │
                             │                                     │
                             └──────────────────┬──────────────────┘
                                                │
                                                │ Push通知 (リアルタイム)
                                                ▼
                             ┌─────────────────────────────────────┐
                             │           ngrok (トンネル)          │
                             │     https://xxxx.ngrok-free.app     │
                             └──────────────────┬──────────────────┘
                                                │
                                                ▼
                             ┌─────────────────────────────────────┐
                             │              Mac                    │
                             │        structured_transcriber       │
                             │                                     │
                             │  ┌─────────────────────────────┐   │
                             │  │ 1. 新規ファイル検知          │   │
                             │  │ 2. ダウンロード              │   │
                             │  │ 3. Gemini API で文字起こし   │   │
                             │  │ 4. 構造化処理               │   │
                             │  │ 5. 結果をDriveに保存        │   │
                             │  └─────────────────────────────┘   │
                             │                                     │
                             └─────────────────────────────────────┘
                                                │
                                                ▼
                             ┌─────────────────────────────────────┐
                             │            Google Drive              │
                             │                                     │
                             │  📁 VoiceMemo/transcripts/          │
                             │     ├── 2026-01-05_143022.json     │
                             │     └── 2026-01-05_150511.json     │
                             └─────────────────────────────────────┘
```

### 2.2 コンポーネント

| コンポーネント | 役割 | 技術 |
|--------------|------|------|
| iPhone App | 録音 + Google Driveアップロード | Swift / Google Drive SDK |
| Google Drive | ファイルストレージ | Google Cloud |
| Mac Webhookサーバー | 新規ファイル検知 + 処理実行 | 既存 webhook_server.py（Push通知） |
| 文字起こしエンジン | 音声→構造化テキスト | 既存 structured_transcribe.py |

---

## 3. 処理フロー

### 3.1 シーケンス図

```
  時間軸 ──────────────────────────────────────────────────────────▶

  ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐   ┌────────┐
  │ User   │   │ iPhone │   │ GDrive │   │  Mac   │   │ Gemini │
  └───┬────┘   └───┬────┘   └───┬────┘   └───┬────┘   └───┬────┘
      │            │            │            │            │
 ═════╪════════════╪════════════╪════════════╪════════════╪═════
      │  PHASE 1: 録音 + アップロード        │            │
 ═════╪════════════╪════════════╪════════════╪════════════╪═════
      │            │            │            │            │
      │──録音開始─▶│            │            │            │
      │            │──m4a録音──▶│            │            │
      │◀─録音停止──│            │            │            │
      │            │            │            │            │
      │            │══Upload═══▶│            │            │
      │            │ (自動)     │            │            │
      │            │◀══完了════│            │            │
      │            │            │            │            │
      │◀─✓表示────│            │            │            │
      │            │            │            │            │
 ═════╪════════════╪════════════╪════════════╪════════════╪═════
      │  PHASE 2: 検知 + 処理（リアルタイム・自動）        │
 ═════╪════════════╪════════════╪════════════╪════════════╪═════
      │            │            │            │            │
      │            │            │──Push通知─▶│            │
      │            │            │ (即時)     │            │
      │            │            │            │            │
      │            │            │            │            │
      │            │            │◀Download──│            │
      │            │            │────────────▶            │
      │            │            │            │            │
      │            │            │            │══文字起こし▶│
      │            │            │            │◀══結果════│
      │            │            │            │            │
      │            │            │            │──構造化───▶│
      │            │            │            │            │
      │            │            │◀─結果保存─│            │
      │            │            │            │            │
 ═════╪════════════╪════════════╪════════════╪════════════╪═════
      │  完了      │            │            │            │
 ═════╪════════════╪════════════╪════════════╪════════════╪═════
      ▼            ▼            ▼            ▼            ▼
```

### 3.2 データ変換

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│                  │     │                  │     │                  │
│   audio.m4a      │────▶│   Gemini API     │────▶│   result.json    │
│   (音声)         │     │   (文字起こし)    │     │   (構造化)       │
│                  │     │                  │     │                  │
└──────────────────┘     └──────────────────┘     └──────────────────┘

出力形式:
{
  "metadata": {
    "original_file": "2026-01-05_143022.m4a",
    "processed_at": "2026-01-05T14:35:00Z"
  },
  "segments": [
    {"speaker": "Speaker 1", "text": "...", "timestamp": "00:00"},
    {"speaker": "Speaker 2", "text": "...", "timestamp": "00:15"}
  ],
  "summary": "会議の要約..."
}
```

---

## 4. Google Drive フォルダ構造

```
Google Drive
└── VoiceMemo/
    ├── audio/                    # 音声ファイル（iPhoneがアップロード）
    │   ├── 2026-01-05_143022.m4a
    │   └── 2026-01-05_150511.m4a
    │
    ├── transcripts/              # 文字起こし結果（Macが保存）
    │   ├── 2026-01-05_143022.json
    │   └── 2026-01-05_150511.json
    │
    └── processed/                # 処理済み音声（アーカイブ）
        └── 2026-01-05_143022.m4a
```

---

## 5. 実装フェーズ

### Phase 1: iPhoneアプリ（Google Driveアップロード機能）

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 1: iOSアプリ拡張                                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1.1: Google Sign-In SDK導入                               │
│  ├── CocoaPods or SPM で GoogleSignIn 追加                      │
│  ├── OAuth 2.0 クライアントID取得（Google Cloud Console）       │
│  └── Info.plist に URL Scheme 追加                              │
│                                                                 │
│  Step 1.2: Google Drive API連携                                 │
│  ├── GoogleAPIClientForREST-Drive 追加                          │
│  └── アップロード処理実装（GTLRDriveService）                    │
│                                                                 │
│  Step 1.3: アップロード機能実装                                  │
│  ├── 新規ファイル: GoogleDriveUploader.swift                    │
│  ├── 認証フロー（初回のみ）                                      │
│  ├── 録音完了時に自動アップロード                                │
│  └── アップロード状態UI表示                                      │
│                                                                 │
│  Step 1.4: 設定画面                                              │
│  ├── Googleアカウント連携ボタン                                  │
│  ├── 自動アップロードON/OFF                                      │
│  └── アップロード先フォルダ表示                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Phase 2: Mac Webhookサーバー設定

```
┌─────────────────────────────────────────────────────────────────┐
│  Phase 2: Mac側（既存 structured_transcriber 活用）              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 2.1: ngrok セットアップ                                    │
│  ├── ngrok インストール（brew install ngrok）                   │
│  ├── ngrok アカウント登録・認証トークン設定                     │
│  └── ngrok http 8000 で公開URL取得                              │
│                                                                 │
│  Step 2.2: 既存 webhook_server.py の設定                         │
│  ├── .env に WEBHOOK_PUBLIC_URL=https://xxxx.ngrok-free.app 設定│
│  ├── 監視対象を My Drive root → VoiceMemo/audio に変更（必要時）│
│  └── uvicorn で起動                                             │
│                                                                 │
│  Step 2.3: Webhook 登録                                          │
│  ├── サーバー起動時に自動登録（ENABLE_WEBHOOK_AUTO_RENEWAL=true）│
│  └── または /setup エンドポイントで手動登録                      │
│                                                                 │
│  ※ 既存実装をそのまま活用（新規コード不要）                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. ファイル変更一覧

### 6.1 iPhoneアプリ

| ファイル | 種別 | 説明 |
|---------|-----|------|
| GoogleDriveUploader.swift | 新規 | Drive API連携・アップロード |
| SettingsView.swift | 新規 | 設定画面（Google連携） |
| VoiceMemo.swift | 変更 | uploadStatus追加 |
| RecordingView.swift | 変更 | 保存後にアップロード呼び出し |
| ContentView.swift | 変更 | アップロード状態表示 |
| project.yml | 変更 | 依存パッケージ追加 |

### 6.2 structured_transcriber（Mac側）

| ファイル | 種別 | 説明 |
|---------|-----|------|
| .env | 変更 | WEBHOOK_PUBLIC_URL追加 |
| src/services/monitoring/webhook_server.py | 既存 | そのまま活用（変更不要） |

---

## 7. 設定値

### 7.1 Google Cloud Console設定

| 項目 | 説明 |
|-----|------|
| OAuth 2.0 クライアントID | iOSアプリ用 |
| Drive API 有効化 | 必須 |
| スコープ | `drive.file`（アプリが作成したファイルのみ） |

### 7.2 環境変数（.env追加分）

| 変数名 | 説明 |
|-------|------|
| WEBHOOK_PUBLIC_URL | ngrokの公開URL（例: https://xxxx.ngrok-free.app） |
| ENABLE_WEBHOOK_AUTO_RENEWAL | Webhook自動更新（true推奨） |
| CHANNEL_EXPIRATION_HOURS | Webhook有効期限（デフォルト: 24時間） |

---

## 8. メリット

| 項目 | 説明 |
|-----|------|
| リアルタイム検知 | Push通知で即座に処理開始（Polling不要） |
| 既存実装活用 | webhook_server.py をそのまま使用（Mac側新規コード不要） |
| オフライン対応 | iPhoneがオフラインでも録音可能、オンライン時に自動同期 |
| 信頼性 | Google Driveの同期機能に依存（実績あり） |
| スケーラブル | 将来的にCloud Functions等へ移行可能 |

---

## 9. 運用手順

### 9.1 初回セットアップ

```
1. Google Cloud Consoleでプロジェクト作成
2. Drive API有効化 + OAuth 2.0クライアントID取得（iOS用）
3. iPhoneアプリにクライアントID設定
4. ngrok セットアップ（brew install ngrok + 認証）
5. .env に WEBHOOK_PUBLIC_URL 設定
```

### 9.2 日常運用

```
1. [Mac] ngrok http 8000 を起動（公開URL取得）
2. [Mac] webhook_server.py を起動
3. [iPhone] 録音 → 自動アップロード
4. [Mac] 即座にPush通知受信 → 文字起こし → 結果保存
5. [ユーザー] Google Driveで結果確認
```

---

## 10. 今後の拡張（参考）

| 項目 | 説明 | 優先度 |
|-----|------|-------|
| Cloud Functions化 | Mac不要で常時監視 | 中 |
| プッシュ通知 | 処理完了時にiPhoneへ通知 | 低 |
| 結果表示UI | アプリ内で文字起こし結果を閲覧 | 中 |

---

**以上**
