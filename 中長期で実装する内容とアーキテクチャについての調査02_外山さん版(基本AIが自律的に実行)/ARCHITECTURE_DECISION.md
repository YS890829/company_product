# アーキテクチャ決定事項

**作成日**: 2026-01-09
**最終更新**: 2026-01-09
**ステータス**: ✅ アーキテクチャ策定完了

---

## 1. エグゼクティブサマリー

### 1.1 システム概要

ボイスメモアプリは、iPhone/Web/将来のAndroidから録音を行い、AI文字起こし・構造化を経て、SFA/CRMシステムと連携する**マルチプラットフォーム音声処理プラットフォーム**である。

### 1.2 アーキテクチャ方針

**「コスト最適化 + 段階的拡張」**

- **Phase 1**: ローカル完結（iOS単体）で開発・検証
- **Phase 1.5**: ローカルMacサーバーで初期顧客対応（$0運用）
- **Phase 2以降**: Cloud Runでスケーラブルに拡張
- 将来のGKE移行パスを確保

### 1.3 主要決定事項

| 項目 | 決定内容 |
|------|---------|
| **クラウド** | Google Cloud Platform |
| **コンピューティング** | Cloud Run（サーバーレス） |
| **フロントエンド** | Swift (iOS) + React PWA (Web) |
| **バックエンド** | Python FastAPI |
| **AI** | Gemini 2.5 Flash |
| **データベース** | Firestore + GCS + Chroma Cloud |
| **連携方式** | REST API + Webhook |

---

## 2. 全体アーキテクチャ

### 2.1 システム構成図

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                             ボイスメモ システム構成                                    │
│                                                                                     │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                          クライアント層                                       │    │
│  │   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐              │    │
│  │   │  iPhone     │      │   Web App   │      │  (将来)      │              │    │
│  │   │  App        │      │  (PWA)      │      │  Android    │              │    │
│  │   │  [Swift]    │      │  [React]    │      │             │              │    │
│  │   └──────┬──────┘      └──────┬──────┘      └──────┬──────┘              │    │
│  └──────────┼────────────────────┼────────────────────┼──────────────────────┘    │
│             └────────────────────┼────────────────────┘                           │
│                                  │ HTTPS                                          │
│                                  ▼                                                │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                         Google Cloud Platform                               │    │
│  │                                                                            │    │
│  │   ┌──────────────────────────────────────────────────────────────────┐    │    │
│  │   │                      API Gateway (Cloud Run)                     │    │    │
│  │   │                 JWT認証 / ルーティング / レート制限                │    │    │
│  │   └──────────────────────────────┬───────────────────────────────────┘    │    │
│  │                                  │                                        │    │
│  │   ┌──────────────────────────────┼──────────────────────────────┐        │    │
│  │   │                              │                              │        │    │
│  │   ▼                              ▼                              ▼        │    │
│  │   ┌───────────┐           ┌───────────┐           ┌───────────┐          │    │
│  │   │ Recording │           │Transcription           │  Storage  │          │    │
│  │   │ Service   │──────────▶│ Service   │──────────▶│  Service  │          │    │
│  │   └───────────┘           └─────┬─────┘           └─────┬─────┘          │    │
│  │                                 │                       │                │    │
│  │                                 ▼                       │                │    │
│  │                          ┌───────────┐                  │                │    │
│  │                          │  Search   │◀─────────────────┘                │    │
│  │                          │  Service  │                                   │    │
│  │                          └─────┬─────┘                                   │    │
│  │                                │                                         │    │
│  │   ┌────────────────────────────┼────────────────────────────────────┐    │    │
│  │   │                    Cloud Pub/Sub (イベント駆動)                   │    │    │
│  │   └────────────────────────────┬────────────────────────────────────┘    │    │
│  │                                │                                         │    │
│  │                          ┌─────▼─────┐                                   │    │
│  │                          │   CRM     │                                   │    │
│  │                          │  Gateway  │                                   │    │
│  │                          └─────┬─────┘                                   │    │
│  └────────────────────────────────┼─────────────────────────────────────────┘    │
│                                   │ REST + Webhook                               │
│                                   ▼                                              │
│  ┌────────────────────────────────────────────────────────────────────────────┐    │
│  │                    Revenue Intelligence Platform (SFA/CRM)                  │    │
│  └────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 データストア構成

| ストア | 用途 | 技術 |
|--------|------|------|
| **音声ファイル** | 録音データ保存 | Cloud Storage (GCS) |
| **メタデータ** | 録音情報、処理状態 | Firestore |
| **ベクトル** | セマンティック検索 | Chroma Cloud |
| **シークレット** | APIキー、認証情報 | Secret Manager |

---

## 3. 技術スタック

### 3.1 フロントエンド

| カテゴリ | 技術 | 備考 |
|---------|------|------|
| **iOS** | Swift 6 + SwiftUI | ネイティブアプリ |
| **iOS データ** | SwiftData | ローカル永続化 |
| **Web** | React 19 + TypeScript | PWA対応 |
| **Web 状態管理** | Zustand | 軽量 |
| **Web 録音** | MediaRecorder API | ブラウザ標準 |
| **Web ビルド** | Vite 6 | 高速ビルド |

### 3.2 バックエンド

| カテゴリ | 技術 | 備考 |
|---------|------|------|
| **言語** | Python 3.13+ | 最新 |
| **フレームワーク** | FastAPI 0.115+ | 非同期対応 |
| **バリデーション** | Pydantic 2.x | 型安全 |
| **サーバー** | Uvicorn | ASGI |

### 3.3 AI/ML

| 用途 | 技術 | モデル |
|------|------|--------|
| **文字起こし** | Gemini Audio API | Gemini 2.5 Flash |
| **構造化・要約** | Gemini API | Gemini 2.5 Flash |
| **エンベディング** | ChromaDB | text-embedding-3-small |

### 3.4 インフラストラクチャ

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| **コンピューティング** | Cloud Run | 全サービス |
| **メッセージング** | Cloud Pub/Sub | 非同期イベント |
| **ストレージ** | GCS | 音声ファイル |
| **データベース** | Firestore | メタデータ |
| **ベクトルDB** | Chroma Cloud | 検索 |
| **認証** | Firebase Auth | ユーザー認証 |

### 3.5 DevOps

| カテゴリ | 技術 |
|---------|------|
| **CI** | GitHub Actions |
| **CD** | Cloud Build |
| **モニタリング** | Cloud Monitoring + Cloud Trace |
| **ロギング** | Cloud Logging |
| **コンテナ** | Artifact Registry |

---

## 4. マイクロサービス構成

### 4.1 サービス一覧

| サービス | 責務 | 技術 | データストア |
|---------|------|------|------------|
| **API Gateway** | 認証・ルーティング | Cloud Run | - |
| **Recording Service** | 録音受付 | Cloud Run | GCS |
| **Transcription Service** | 文字起こし | Cloud Run + Gemini | - |
| **Storage Service** | データ管理 | Cloud Run | Firestore |
| **Search Service** | 検索機能 | Cloud Run | Chroma Cloud |
| **CRM Gateway** | SFA/CRM連携 | Cloud Run | - |

### 4.2 通信方式

| 通信 | 方式 | プロトコル |
|------|------|----------|
| **外部→内部** | REST | HTTPS/JSON |
| **内部同期** | REST（将来gRPC） | HTTP/JSON |
| **内部非同期** | Pub/Sub | イベント |
| **CRM連携** | REST + Webhook | HTTPS/JSON |

### 4.3 認証方式

| フェーズ | 方式 | 対象 |
|---------|------|------|
| **Phase 1-2** | API Key | 内部サービス間 |
| **Phase 2-3** | JWT | ユーザー認証 |
| **Phase 4+** | OAuth 2.0 | 外部連携 |

---

## 5. 実装ロードマップ

### 5.1 フェーズ概要

| フェーズ | 期間 | 内容 | 月額コスト | 対象顧客 |
|---------|------|------|-----------|---------|
| **Phase 1** | 2026 Q1 | iOS基盤構築 | **$0** | 開発・検証 |
| **Phase 1.5** 🆕 | 2026 Q1-Q2 | ローカルMacサーバー | **$0** | 1社 |
| **Phase 2** | 2026 Q2-Q3 | クラウド移行 | $16-64 | 10社+ |
| **Phase 3** | 2026 Q3-Q4 | Web版開発 | +$20-50 | 50社+ |
| **Phase 4** | 2026 Q4 | CRM連携 | - | - |
| **Phase 5** | 2027 Q1+ | 最適化 | - | - |

### 5.2 Phase 1: iOS基盤構築（現在進行中）

| タスク | 状態 |
|--------|------|
| SwiftData導入 | ⬜ 未着手 |
| KeychainService | ✅ 完了 |
| 設定画面 | ⬜ 未着手 |
| 録音機能 | ⬜ 未着手 |
| TranscriptionProvider抽象化 | ⬜ 未着手 |

### 5.2.5 Phase 1.5: ローカルMacサーバー 🆕

**目的**: 初期顧客（1社）対応をコスト$0で実現

**アーキテクチャ**:

```
┌─────────────────────────────────────────────────────────────────┐
│                    Phase 1.5 アーキテクチャ                       │
│                                                                 │
│   ┌─────────────┐          同一Wi-Fi/VPN          ┌──────────┐  │
│   │  iPhone     │ ─────── HTTP (REST API) ───────▶│ MacBook  │  │
│   │  App        │         :8001                   │ Pro      │  │
│   │  [Swift]    │                                 │          │  │
│   └─────────────┘                                 │ FastAPI  │  │
│                                                   │ ChromaDB │  │
│                                                   │ SQLite   │  │
│                                                   └────┬─────┘  │
│                                                        │ HTTPS  │
│                                                        ▼        │
│                                                   ┌──────────┐  │
│                                                   │ Gemini   │  │
│                                                   │ API      │  │
│                                                   │ (無料枠) │  │
│                                                   └──────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

**活用する既存資産**: `structured_transcriber`

| コンポーネント | 技術 | 状態 |
|--------------|------|------|
| APIサーバー | FastAPI + Uvicorn | ✅ 既存 |
| ベクトルDB | ChromaDB | ✅ 既存 |
| メタデータDB | SQLite | ✅ 既存 |
| API連携 | Gemini API | ✅ 既存 |

**タスク一覧**:

| タスク | 内容 |
|--------|------|
| iPhoneアプリ側 | サーバーモード追加（URL設定） |
| Mac側 | structured_transcriberの起動設定 |
| ネットワーク | CORS設定、ファイアウォール許可 |
| 運用 | Mac常時起動、自動復旧設定 |

**Phase 1.5 の制約と対策**:

| 制約 | 対策 |
|-----|------|
| Mac常時起動必要 | スリープ無効化、自動起動設定 |
| 同一ネットワーク制限 | VPN or Tailscale導入 |
| 単一障害点 | バックアップ運用、障害時連絡体制 |
| スケール限界 | 顧客10社超でPhase 2へ移行 |

### 5.3 Phase 2: クラウド移行

| タスク | 内容 |
|--------|------|
| GCP設定 | プロジェクト、IAM、ネットワーク |
| Cloud Run | Transcription/Storage/Search Service |
| データストア | GCS、Firestore、Chroma Cloud |
| モニタリング | Cloud Trace、Cloud Monitoring |

### 5.4 Phase 3: Web版開発

| タスク | 内容 |
|--------|------|
| React設定 | Vite + TypeScript + PWA |
| 録音機能 | MediaRecorder API |
| 認証統合 | Firebase Auth |
| オフライン | Service Worker、IndexedDB |

### 5.5 Phase 4: CRM連携

| タスク | 内容 |
|--------|------|
| CRM Gateway | Webhook受信、データ変換 |
| API v2 | revenue-intelligence-platform拡張 |
| エラー処理 | リトライ、Circuit Breaker |

---

## 6. コスト見積もり

### 6.1 フェーズ別コスト

| フェーズ | 構成 | 月額 | 年間 | 対象 |
|---------|------|------|------|------|
| **Phase 1** | ローカル完結 | **$0** | **$0** | 開発・検証 |
| **Phase 1.5** 🆕 | ローカルMac | **$0** | **$0** | 1社 |
| **Phase 2** | Cloud Run | $16-64 | $192-768 | 10社+ |
| **Phase 3** | Cloud Run + PWA | $36-114 | $432-1,368 | 50社+ |

### 6.2 Phase 1.5 コスト内訳（$0運用）

| 項目 | コスト | 備考 |
|------|-------|------|
| Gemini API | $0 | 無料枠: 1,500件/日 |
| ChromaDB | $0 | ローカル運用 |
| サーバー | $0 | 既存MacBook Pro利用 |
| ネットワーク | $0 | 社内Wi-Fi利用 |
| **合計** | **$0/月** | 顧客1社なら十分 |

### 6.3 Cloud移行後コスト（Phase 2以降）

| 規模 | ユーザー数 | 月額目安 |
|------|----------|---------|
| **初期** | 10人 | $16-64 |
| **成長期** | 50人 | $108-301 |
| **本格運用** | 200人 | $482-1,265 |

### 6.4 主要コスト内訳（Cloud移行後）

| サービス | 初期 | 成長期 | 本格運用 |
|---------|------|-------|---------|
| Cloud Run | $5-20 | $30-80 | $100-300 |
| GCS | $1-2 | $5-10 | $20-30 |
| Gemini API | $10-30 | $50-150 | $200-600 |
| その他 | $0-12 | $23-61 | $162-335 |

### 6.5 初期クレジット

- **GCP新規アカウント**: $300クレジット（6-18ヶ月分相当）

---

## 7. リスクと対策

### 7.1 高優先度リスク

| リスク | 対策 |
|--------|------|
| Gemini API障害 | OpenAI Whisperフォールバック準備 |
| データ不整合 | 冪等性キー必須、Sagaパターン検討 |
| セキュリティ | WAF、IAM最小権限、定期脆弱性スキャン |
| コスト急増 | 予算アラート、利用量上限設定 |

### 7.2 中優先度リスク

| リスク | 対策 |
|--------|------|
| コールドスタート | 最小インスタンス=1、ウォームアップ |
| Safari互換性 | ポリフィル準備、WAVサポート |
| ChromaDB限界 | シャーディング計画、Pinecone検討 |

---

## 8. 残課題

### 8.1 高優先度

| 課題 | 対応時期 |
|------|---------|
| API Gateway実装方式 | Phase 2 |
| Gemini APIコスト詳細検証 | Phase 2 |
| Safari互換性テスト | Phase 3 |
| Webhook署名検証 | Phase 4 |

### 8.2 中優先度

| 課題 | 対応時期 |
|------|---------|
| サービス間認証詳細設計 | Phase 2 |
| コールドスタート対策 | Phase 2 |
| React状態管理選定 | Phase 3 |
| レート制限設計 | Phase 4 |

---

## 9. 関連ドキュメント

### 9.1 調査ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| [01_multiplatform.md](./01_multiplatform.md) | マルチプラットフォーム対応 |
| [02_server_migration.md](./02_server_migration.md) | サーバー移行計画 |
| [03_sfa_crm_integration.md](./03_sfa_crm_integration.md) | SFA/CRM連携 |
| [04_microservices.md](./04_microservices.md) | マイクロサービス設計 |
| [05_integrated_architecture.md](./05_integrated_architecture.md) | 統合アーキテクチャ |
| [06_AI_DRIVEN_DEVELOPMENT_PLAN.md](./06_AI_DRIVEN_DEVELOPMENT_PLAN.md) | **AI駆動開発統合プラン** 🆕 |

### 9.2 実装ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| PHASE1_PLAN.md | Phase 1詳細プラン |
| CLAUDE.md | プロジェクト指示 |
| RESEARCH_PLAN.md | 調査プラン |

---

## 10. 次のアクション

1. **Phase 1 継続**: iOS基盤構築（SwiftData、設定画面、録音機能）
2. **Phase 1 追加**: TranscriptionProvider抽象化（Phase 1.5/2対応）
3. **Phase 1.5 準備**: structured_transcriber起動設定、CORS設定
4. **Phase 2 準備**: GCPプロジェクト設定、Cloud Run検証（顧客10社超時）

---

## 11. 移行判断基準

### Phase 1.5 → Phase 2 移行トリガー

| トリガー | 条件 |
|---------|------|
| 顧客数増加 | 10社超 |
| 外部アクセス需要 | VPNでは対応困難 |
| 可用性要件 | 99.9% SLA必要 |
| Macリソース限界 | 同時処理数が限界 |

上記いずれかに該当した場合、Phase 2（Cloud Run移行）を開始する。

---

**更新履歴:**
- 2026-01-09: 初版作成
- 2026-01-09: 統合アーキテクチャ策定完了、全テーマ調査結果統合
- 2026-01-09: Phase 1.5（ローカルMacサーバー）追加、コスト最適化ロードマップに変更
- 2026-01-09: **AI駆動開発統合プラン追加**（外山英幸氏の思想を統合）
